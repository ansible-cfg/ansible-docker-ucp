---
- hosts: dtr
  gather_facts: false
  become_user: root
  become: true

  vars_files:
    - vars.yml

  tasks:
    - name: Install NFS server
      yum:
        name: "{{ item }}"
        state: latest
      with_items:
        - rpcbind
        - nfs-utils
      environment:
        http_proxy: http://{{ proxy_host }}:{{ proxy_port }}
        https_proxy: https://{{ proxy_host }}:{{ proxy_port }}
      when: inventory_hostname in groups.dtr-main

    - name: Install NFS client
      yum:
        name: nfs-utils
        state: latest
      environment:
        http_proxy: http://{{ proxy_host }}:{{ proxy_port }}
        https_proxy: https://{{ proxy_host }}:{{ proxy_port }}
      when: inventory_hostname not in groups.dtr-main

    - name: Create folder
      file:
        path: "{{ images_folder }}"
        state: directory
        mode: 0777

    - name: Modify exports file on NFS server
      blockinfile:
        path: /etc/exports
        block: |
          {{ images_folder }} dp-dtr*(rw,sync,no_root_squash,no_all_squash)
      when: inventory_hostname == 'dp-dtr01'

    - name: Refresh exportfs
      command: exportfs -a
      when: inventory_hostname == 'dp-dtr01'

    - name: Enable and start NFS services on server
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      with_items:
        - rpcbind
        - nfs-server
        - nfs-lock
        - nfs-idmap
      when: inventory_hostname == 'dp-dtr01'

    - name: Open required ports
      command: firewall-cmd --permanent --zone=public --add-port=2049/tcp --add-port=2049/udp --add-port=111/tcp --add-port=111/udp --add-port=54302/tcp --add-port=54302/udp --add-port=20048/tcp --add-port=20048/udp --add-port=46666/tcp --add-port=46666/udp --add-port=42955/tcp --add-port=42955/udp --add-port=875/tcp --add-port=875/udp
      when: inventory_hostname == 'dp-dtr01'

    - name: Reload firewalld
      command: firewall-cmd --reload
      when: inventory_hostname == 'dp-dtr01'
